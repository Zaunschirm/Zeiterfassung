<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Zeiterfassung</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#c9b8a6" id="metaTheme"/>
  <link rel="icon" href="./icons/icon-192.png">
  <style>
    :root{--bg:#faf8f6;--card:#fff;--ink:#2b261f;--muted:#8b857e;--primary:#c9b8a6;--primaryText:#2b261f;--button:#8c7b6a;--line:#e5e7eb}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    header{background:var(--primary);color:var(--primaryText);padding:10px 14px;display:flex;justify-content:space-between;align-items:center}
    .brand{display:flex;gap:10px;align-items:center}
    .brand img{height:34px;width:auto;object-fit:contain}
    main{max-width:1200px;margin:0 auto;padding:16px}
    .card{background:var(--card);border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.06);padding:16px;margin:12px 0}
    label{display:block;font-size:14px;margin:8px 0 4px}
    input,select,button{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;font:inherit}
    input.inline,select.inline{padding:6px 8px}
    button{background:var(--button);color:#fff;cursor:pointer}
    button.ghost{background:#fff;color:var(--ink);border:1px solid #d1d5db}
    button.secondary{background:#6b7280}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>*{flex:1 1 220px}
    .hidden{display:none}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eee;font-size:14px;text-align:left}
    th.right,td.right{text-align:right}
    tfoot td{font-weight:600}
    .thumbs{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .thumbs figure{margin:0}
    .thumbs img{width:110px;height:110px;object-fit:cover;border-radius:8px;border:1px solid #ddd;display:block}
    .thumbs figcaption{font-size:12px;color:#666;text-align:center;margin-top:4px}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff}
    .cb-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px}
    .cb-item{display:flex;align-items:center;gap:10px;padding:8px;border:1px solid var(--line);border-radius:10px;background:#fff}
    .cb-item input{width:auto}
    .muted{color:var(--muted)}
  </style>
  <script>
  async function applyBranding(){
    try{
      const r=await fetch('./config.json',{cache:'reload'});
      const c=await r.json();
      for(const [k,v] of Object.entries({bg:c.bg, card:c.card, primary:c.primary, primaryText:c.primaryText, accent:c.accent, muted:c.muted})){
        if(v) document.documentElement.style.setProperty('--'+(k==='accent'?'button':k), v);
      }
      if(c.appName){document.title=c.appName; const t=document.getElementById('brandTitle'); if(t)t.textContent=c.appName;}
      if(c.logoPath){const i=document.getElementById('brandLogo'); if(i)i.src=c.logoPath;}
      const meta=document.getElementById('metaTheme'); if(meta&&c.primary)meta.setAttribute('content',c.primary);
    }catch(e){}
  }
  </script>
</head>
<body onload="applyBranding()">
<header>
  <div class="brand">
    <img id="brandLogo" src="./assets/logo.png" alt="Logo">
    <strong id="brandTitle">Zeiterfassung</strong>
  </div>
  <div class="row" style="flex:0 0 auto;gap:8px;align-items:center">
    <a href="users/" id="linkUsers" class="ghost" style="text-decoration:none;display:inline-block;width:auto">Mitarbeiterverwaltung</a>
    <button id="btnLogout" class="ghost">Logout</button>
  </div>
</header>

<main>
  <section id="loginView" class="card">
    <h2>Anmelden</h2>
    <div class="row">
      <div><label>Nutzername<input id="loginUser" autocomplete="username"></label></div>
      <div><label>Passwort<input id="loginPass" type="password" autocomplete="current-password"></label></div>
    </div>
    <div class="row"><button id="btnLogin">Login</button></div>
  </section>

  <section id="forcePwView" class="card hidden">
    <h2>Passwort √§ndern</h2>
    <p>Bitte setze ein neues Passwort, bevor du die App verwendest.</p>
    <div class="row">
      <div><label>Neues Passwort<input id="pwNew" type="password"></label></div>
      <div><label>Wiederholen<input id="pwNew2" type="password"></label></div>
    </div>
    <div class="row">
      <button id="btnSetPw">Passwort speichern</button>
    </div>
  </section>

  <section id="appView" class="hidden">
    <div class="card">
      <h2>Zeiteingabe</h2>
      <div class="row">
        <div><label>Projekt / Kostenstelle<select id="projectSelect"></select></label></div>
        <div><label>Pausen (Minuten)<select id="breakMin">
          <option>0</option><option>15</option><option selected>30</option><option>45</option><option>60</option>
        </select></label></div>
        <div><label>Bemerkung<input id="noteInput" placeholder="z. B. Montage, Fahrtzeit"></label></div>
      </div>

      <div class="row">
        <div style="flex:1 1 100%">
          <div class="row" style="align-items:center">
            <output id="startOut">06:45</output>
            <input id="startRange" type="range" min="16" max="80" step="1" value="27"><span>Start</span>
          </div>
          <div class="row" style="align-items:center">
            <output id="endOut">16:30</output>
            <input id="endRange" type="range" min="16" max="80" step="1" value="66"><span>Ende</span>
          </div>
        </div>
      </div>
      <div class="row">
        <div><label>Datum<input type="date" id="manualDate"></label></div>
        <div><label>Arbeitszeit (HH:MM)<input id="workMinPreview" readonly></label></div>
      </div>

      <div class="card" style="margin-top:8px">
        <h3 style="margin-top:0">Mitarbeiter ausw√§hlen</h3>
        <div id="userCheckboxes" class="cb-list"></div>
        <div class="row" style="margin-top:8px">
          <button id="btnAddEntry">Nur f√ºr mich speichern</button>
          <button id="btnAddBatch" class="secondary">F√ºr alle ausgew√§hlten speichern</button>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div><button id="btnAddPhotos" class="ghost">üì∑ Projekt‚ÄëFotos hinzuf√ºgen</button></div>
      </div>
      <div id="photoWrap" class="hidden">
        <h3 style="margin-top:6px">Projektfotos</h3>
        <div id="photoGallery" class="thumbs"></div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="align-items:flex-end">
        <h3 style="flex:1 1 200px">√úbersicht Monat</h3>
        <div><label>Monat<input type="month" id="monthPicker"></label></div>
        <div><label>Nutzer<select id="userFilter"></select></label></div>
      </div>
      <p id="editHint" class="muted" style="margin:0 0 8px"></p>
      <table id="monthTable">
        <thead><tr><th>Datum</th><th>Von</th><th>Bis</th><th>Projekt</th><th class="right">Kostenstelle</th><th class="right">Pausen</th><th class="right">Arbeitszeit</th><th class="right">√úberstunden</th><th>Notiz</th><th>Aktion</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><td colspan="6" class="right">Summe</td><td class="right" id="sumWork">00:00</td><td class="right" id="sumOT">00:00</td><td></td><td></td></tr></tfoot>
      </table>
      <div class="row" style="margin-top:8px">
        <button id="btnExportCSV" class="ghost">CSV‚ÄëExport</button>
        <button id="btnExportPDF" class="ghost">PDF‚ÄëExport</button>
      </div>
    </div>

    <div class="card" id="adminPanel">
      <h3>Projekte (Admin)</h3>
      <div class="row">
        <div><label>Name<input id="newProjectName"></label></div>
        <div><label>Kostenstelle<input id="newProjectCost"></label></div>
        <div style="align-self:end"><button id="btnAddProject">Hinzuf√ºgen</button></div>
      </div>
      <div id="projectList" style="margin-top:10px"></div>
    </div>
  </section>
</main>

<script>
(function(){
  const a=document.getElementById('linkUsers');
  a.addEventListener('click',function(ev){
    ev.preventDefault();
    const p=location.pathname; const base=p.endsWith('/')?p:p.replace(/[^/]+$/,'');
    location.href=location.origin+base+'users/';
  });
})();

if (location.protocol.startsWith('http')) { navigator.serviceWorker && navigator.serviceWorker.register('./sw.js'); }

const DB_NAME='zeit-web-pwa', DB_VERSION=8; // bump
const STORE={ users:'users', projects:'projects', entries:'entries', photos:'photos' };
function withDB(){return new Promise((resolve,reject)=>{const r=indexedDB.open(DB_NAME,DB_VERSION);
  r.onupgradeneeded=()=>{const db=r.result;
    if(!db.objectStoreNames.contains(STORE.users)) db.createObjectStore(STORE.users,{keyPath:'username'});
    if(!db.objectStoreNames.contains(STORE.projects)) db.createObjectStore(STORE.projects,{keyPath:'id'});
    if(!db.objectStoreNames.contains(STORE.entries)) db.createObjectStore(STORE.entries,{keyPath:'id'});
    if(!db.objectStoreNames.contains(STORE.photos)) db.createObjectStore(STORE.photos,{keyPath:'id'});
  };
  r.onsuccess=()=>resolve(r.result); r.onerror=()=>reject(r.error);
});}
async function put(store,val){const db=await withDB();return new Promise((res,rej)=>{const tx=db.transaction(store,'readwrite');tx.objectStore(store).put(val);tx.oncomplete=()=>res(val);tx.onerror=()=>rej(tx.error);});}
async function get(store,key){const db=await withDB();return new Promise((res,rej)=>{const tx=db.transaction(store,'readonly');const q=tx.objectStore(store).get(key);q.onsuccess=()=>res(q.result);q.onerror=()=>rej(q.error);});}
async function getAll(store){const db=await withDB();return new Promise((res,rej)=>{const tx=db.transaction(store,'readonly');const q=tx.objectStore(store).getAll();q.onsuccess=()=>res(q.result);q.onerror=()=>rej(q.error);});}
async function delRec(store,key){const db=await withDB();return new Promise((res,rej)=>{const tx=db.transaction(store,'readwrite');tx.objectStore(store).delete(key);tx.oncomplete=()=>res(true);tx.onerror=()=>rej(tx.error);});}

let currentUser=null;
function uuid(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16)})}
function todayISO(){ const d=new Date(); d.setHours(0,0,0,0); return d.toISOString().slice(0,10); }
function currentMonth(){ const d=new Date(); return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); }
function ixToTime(ix){ const m=ix*15, h=String(Math.floor(m/60)).padStart(2,'0'), mm=String(m%60).padStart(2,'0'); return h+':'+mm; }
function minToHHMM(m){ const h=Math.floor(m/60), mm=m%60; return String(h).padStart(2,'0')+':'+String(mm).padStart(2,'0'); }
function durationMin(a,b){ return Math.max(0, Math.round((new Date(b)-new Date(a))/60000)); }
function ixToDateISO(dateISO,ix){ const p=dateISO.split('-'); const y=parseInt(p[0],10), mo=parseInt(p[1],10), d=parseInt(p[2],10); const minutes=ix*15; const h=Math.floor(minutes/60), mm=minutes%60; return new Date(y,mo-1,d,h,mm,0).toISOString(); }


async function ensureAdminExists(){
  const users = await getAll(STORE.users);
  const hasAdmin = users && users.some(u => (u.role==='admin') && (u.active!==false));
  if (!hasAdmin) {
    await put(STORE.users, {username:'admin', password:'admin', role:'admin', display:'Administrator', active:true, mustChange:false});
  }
}


function showSection(id){
  document.getElementById('loginView').classList.add('hidden');
  document.getElementById('forcePwView').classList.add('hidden');
  document.getElementById('appView').classList.add('hidden');
  document.getElementById(id).classList.remove('hidden');
}

function isEditor(){
  return currentUser && (currentUser.role==='admin' || currentUser.role==='lead');
}

async function login(u,p){
  await ensureAdminExists();
  const user=await get(STORE.users,u);
  if(!user){ alert('Nutzer nicht gefunden'); return; }
  if(user.active===false){ alert('Nutzer ist deaktiviert'); return; }
  if(user.password!==p){ alert('Passwort falsch'); return; }
  if(user.mustChange===true){
    currentUser=user; localStorage.setItem('cu_pending', JSON.stringify(user)); showSection('forcePwView'); return;
  }
  currentUser=user; localStorage.setItem('cu', JSON.stringify(user));
  await enterApp();
}

async function enterApp(){
  showSection('appView');
  document.getElementById('manualDate').value=todayISO();
  document.getElementById('monthPicker').value=currentMonth();
  const admin = (currentUser.role==='admin');
  document.getElementById('adminPanel').style.display = admin ? 'block' : 'none';
  document.getElementById('editHint').textContent = isEditor() ? 'Monats√ºbersicht ist bearbeitbar (Admin & Teamleiter).' : 'Nur Admin/Teamleiter k√∂nnen Eintr√§ge bearbeiten.';
  // Teamleiter sieht Nutzer-Auswahl wie Admin
  await loadProjects();
  await loadUsersToFilter();
  await renderUserCheckboxes();
  setupRanges();
  await refreshMonth();
  await refreshPhotoGallery();
}

async function finishPasswordChange(){
  const np=document.getElementById('pwNew').value;
  const np2=document.getElementById('pwNew2').value;
  if(np.length<6){ alert('Das Passwort muss mindestens 6 Zeichen haben.'); return; }
  if(np!==np2){ alert('Passw√∂rter stimmen nicht √ºberein.'); return; }
  const pending = JSON.parse(localStorage.getItem('cu_pending')||'null');
  if(!pending){ alert('Kein Nutzer geladen.'); return; }
  const upd = Object.assign({}, pending, {password:np, mustChange:false});
  await put(STORE.users, upd);
  localStorage.removeItem('cu_pending');
  await login(upd.username, np);
}

async function loadProjects(){
  const sel=document.getElementById('projectSelect'); sel.innerHTML='';
  const projs=await getAll(STORE.projects);
  projs.filter(p=>!p.archived).forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=p.costCenter?(p.name+' ('+p.costCenter+')'):p.name; sel.appendChild(o); });
  renderProjectList(projs);
}

function renderProjectList(projs){
  const list=document.getElementById('projectList'); list.innerHTML='';
  projs.forEach(p=>{
    const row=document.createElement('div'); row.className='row '+(p.archived?'archived':'');
    const name=document.createElement('input'); name.value=p.name; name.placeholder='Name';
    const cost=document.createElement('input'); cost.value=p.costCenter||''; cost.placeholder='Kostenstelle';
    const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px';
    const save=document.createElement('button'); save.textContent='Speichern'; save.onclick=async()=>{
      await put(STORE.projects,{id:p.id,name:name.value.trim(),costCenter:(cost.value.trim()||null),archived:!!p.archived}); await loadProjects(); await refreshMonth();
    };
    const arch=document.createElement('button'); arch.className='secondary'; arch.textContent=p.archived?'Wiederherstellen':'Archivieren'; arch.onclick=async()=>{
      await put(STORE.projects,Object.assign({},p,{name:name.value.trim()||p.name,costCenter:(cost.value.trim()||p.costCenter||null),archived:!p.archived})); await loadProjects(); await refreshMonth();
    };
    const delB=document.createElement('button'); delB.className='ghost'; delB.textContent='L√∂schen'; delB.onclick=async()=>{ if(!confirm('Projekt wirklich l√∂schen?')) return; await delRec(STORE.projects,p.id); await loadProjects(); await refreshMonth(); };
    actions.appendChild(save); actions.appendChild(arch); actions.appendChild(delB);
    row.appendChild(name); row.appendChild(cost); row.appendChild(actions);
    list.appendChild(row);
  });
}

function setupRanges(){
  const s=document.getElementById('startRange'), e=document.getElementById('endRange');
  const so=document.getElementById('startOut'), eo=document.getElementById('endOut'), b=document.getElementById('breakMin'), w=document.getElementById('workMinPreview');
  const recalc=()=>{
    if(+e.value<+s.value) e.value=s.value;
    so.textContent=ixToTime(+s.value); eo.textContent=ixToTime(+e.value);
    const mins=(+e.value-+s.value)*15 - parseInt(b.value||'0',10);
    const ot=Math.max(0, mins-540);
    w.value=minToHHMM(Math.max(0,mins))+' (√ú: '+minToHHMM(ot)+')';
  };
  [s,e,b].forEach(x=>{x.oninput=recalc; x.onchange=recalc;}); recalc();
}

async function addEntryManualForUser(userName){
  const dateISO=document.getElementById('manualDate').value||todayISO();
  const sIx=+document.getElementById('startRange').value, eIx=+document.getElementById('endRange').value;
  const breakMin=+document.getElementById('breakMin').value||0; const projectId=document.getElementById('projectSelect').value; const note=document.getElementById('noteInput').value||'';
  if(!projectId) return alert('Bitte Projekt w√§hlen'); if(eIx<sIx) return alert('Ende darf nicht vor Start liegen');
  const entry={id:uuid(),user:userName,date:dateISO,projectId:projectId,note:note,start:ixToDateISO(dateISO,sIx),end:ixToDateISO(dateISO,eIx),breaksMin:breakMin};
  await put(STORE.entries, entry);
}

async function addEntryManual(){
  await addEntryManualForUser(currentUser.username);
  await refreshMonth();
}

function fmt(dt){ if(!dt) return ''; const d=new Date(dt); return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }

async function loadUsersToFilter(){
  const sel=document.getElementById('userFilter'); sel.innerHTML='';
  const users=(await getAll(STORE.users)).filter(u=>u.active!==false);
  const list=isEditor()?users:users.filter(u=>u.username===currentUser.username);
  list.forEach(u=>{ const o=document.createElement('option'); o.value=u.username; o.textContent=u.display||u.username; if(currentUser && u.username===currentUser.username) o.selected=true; sel.appendChild(o); });
  sel.disabled=!isEditor();
}

async function renderUserCheckboxes(){
  const wrap=document.getElementById('userCheckboxes'); wrap.innerHTML='';
  const users=(await getAll(STORE.users)).filter(u=>u.active!==false);
  users.sort((a,b)=> (a.display||a.username).localeCompare(b.display||b.username,'de',{sensitivity:'base'}));
  users.forEach(u=>{
    const id='cb_'+u.username;
    const div=document.createElement('div'); div.className='cb-item';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.id=id; cb.value=u.username;
    if(currentUser && u.username===currentUser.username) cb.checked=true;
    const lab=document.createElement('label'); lab.setAttribute('for', id); lab.textContent=(u.display||u.username);
    if(u.username==='admin') lab.textContent=(u.display||u.username)+' (Admin)';
    if(u.role==='lead') lab.textContent += ' (Teamleiter)';
    div.appendChild(cb); div.appendChild(lab);
    wrap.appendChild(div);
  });
}

async function addBatch(){
  const checks=[...document.querySelectorAll('#userCheckboxes input[type=checkbox]:checked')].map(c=>c.value);
  if(!checks.length){ alert('Bitte mindestens einen Mitarbeiter ausw√§hlen.'); return; }
  for(const u of checks){ await addEntryManualForUser(u); }
  alert('Eintr√§ge f√ºr '+checks.length+' Mitarbeiter gespeichert.');
  await refreshMonth();
}

async function refreshMonth(){
  const monthVal=document.getElementById('monthPicker').value||currentMonth();
  const userVal=document.getElementById('userFilter').value||(currentUser&&currentUser.username);
  const tbody=document.querySelector('#monthTable tbody'); const sumWorkTd=document.getElementById('sumWork'); const sumOtTd=document.getElementById('sumOT');
  const entries=(await getAll(STORE.entries)).filter(e=>e.user===userVal && (e.date||'').startsWith(monthVal));
  const projs=await getAll(STORE.projects); const pm={}; projs.forEach(p=>pm[p.id]=p);
  entries.sort((a,b)=>(a.date||'').localeCompare(b.date||'') || (a.start||'').localeCompare(b.start||''));
  tbody.innerHTML=''; let sumWork=0, sumOT=0;
  const canEdit = isEditor();
  for(const e of entries){
    const work=Math.max(0, durationMin(e.start,e.end)-(e.breaksMin||0)); const ot=Math.max(0, work-540); sumWork+=work; sumOT+=ot;
    const tr=document.createElement('tr');
    const tdDate=document.createElement('td'); tdDate.textContent=e.date;

    const tdFrom=document.createElement('td'); const inFrom=document.createElement('input'); inFrom.className='inline'; inFrom.type='time'; inFrom.step=900; const dFrom=new Date(e.start); inFrom.value=String(dFrom.getHours()).padStart(2,'0')+':'+String(dFrom.getMinutes()).padStart(2,'0'); if(!canEdit) inFrom.disabled=true; tdFrom.appendChild(inFrom);
    const tdTo=document.createElement('td'); const inTo=document.createElement('input'); inTo.className='inline'; inTo.type='time'; inTo.step=900; const dTo=new Date(e.end); inTo.value=String(dTo.getHours()).padStart(2,'0')+':'+String(dTo.getMinutes()).padStart(2,'0'); if(!canEdit) inTo.disabled=true; tdTo.appendChild(inTo);

    const tdProj=document.createElement('td'); const selProj=document.createElement('select'); selProj.className='inline'; if(!canEdit) selProj.disabled=true;
    projs.filter(p=>!p.archived || p.id===e.projectId).forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=p.name; if(p.id===e.projectId) o.selected=true; selProj.appendChild(o); }); tdProj.appendChild(selProj);

    const tdCost=document.createElement('td'); tdCost.className='right'; tdCost.textContent=(pm[e.projectId] && pm[e.projectId].costCenter)||'';

    const tdBreak=document.createElement('td'); tdBreak.className='right'; const selBreak=document.createElement('select'); selBreak.className='inline'; [0,15,30,45,60].forEach(v=>{ const o=document.createElement('option'); o.value=String(v); o.textContent=String(v); if((e.breaksMin||0)===v) o.selected=true; selBreak.appendChild(o); }); if(!canEdit) selBreak.disabled=true; tdBreak.appendChild(selBreak);

    const tdWork=document.createElement('td'); tdWork.className='right'; tdWork.textContent=minToHHMM(work);
    const tdOT=document.createElement('td'); tdOT.className='right'; tdOT.textContent=minToHHMM(ot);
    const tdNote=document.createElement('td'); const inNote=document.createElement('input'); inNote.className='inline'; inNote.value=e.note||''; if(!canEdit) inNote.disabled=true; tdNote.appendChild(inNote);

    const tdAct=document.createElement('td');
    if(canEdit){
      const btn=document.createElement('button'); btn.textContent='Speichern'; btn.onclick=async()=>{
        const t1=inFrom.value.split(':'), t2=inTo.value.split(':');
        const startISO=new Date(e.date+'T'+t1[0]+':'+t1[1]+':00').toISOString();
        const endISO=new Date(e.date+'T'+t2[0]+':'+t2[1]+':00').toISOString();
        const upd=Object.assign({},e,{start:startISO,end:endISO,breaksMin:parseInt(selBreak.value||'0',10),projectId:selProj.value,note:inNote.value});
        await put(STORE.entries,upd); await refreshMonth();
      }; tdAct.appendChild(btn);
    } else {
      tdAct.textContent='-';
    }
    tr.appendChild(tdDate); tr.appendChild(tdFrom); tr.appendChild(tdTo); tr.appendChild(tdProj); tr.appendChild(tdCost); tr.appendChild(tdBreak); tr.appendChild(tdWork); tr.appendChild(tdOT); tr.appendChild(tdNote); tr.appendChild(tdAct);
    tbody.appendChild(tr);
  }
  sumWorkTd.textContent=minToHHMM(sumWork); sumOtTd.textContent=minToHHMM(sumOT);
}

// Photos + compression
function pickFiles(accept='image/*', multiple=true){
  return new Promise(resolve=>{
    const input=document.createElement('input');
    input.type='file'; input.accept=accept; input.multiple=multiple;
    input.onchange=()=>resolve(Array.from(input.files||[]));
    input.click();
  });
}
function compressImage(file, maxDim=1600, quality=0.82){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=()=>{
      const img=new Image();
      img.onload=()=>{
        const scale=Math.min(1, maxDim/Math.max(img.width,img.height));
        const w=Math.round(img.width*scale), h=Math.round(img.height*scale);
        const canvas=document.createElement('canvas');
        canvas.width=w; canvas.height=h;
        const ctx=canvas.getContext('2d');
        ctx.drawImage(img,0,0,w,h);
        const dataUrl=canvas.toDataURL('image/jpeg', quality);
        resolve(dataUrl);
      };
      img.onerror=reject;
      img.src=reader.result;
    };
    reader.onerror=reject;
    reader.readAsDataURL(file);
  });
}
async function addPhotosToProject(){
  const pid=document.getElementById('projectSelect').value;
  if(!pid) return alert('Bitte zuerst ein Projekt w√§hlen');
  const files=await pickFiles('image/*', true);
  for(const f of files){
    const data=await compressImage(f,1600,0.82);
    const rec={id:uuid(),projectId:pid,filename:f.name,dataUrl:data,createdAt:new Date().toISOString()};
    await put(STORE.photos, rec);
  }
  await refreshPhotoGallery();
}
async function refreshPhotoGallery(){
  const pid=document.getElementById('projectSelect').value;
  const wrap=document.getElementById('photoWrap'); const gal=document.getElementById('photoGallery');
  if(!pid){ wrap.classList.add('hidden'); return; }
  const all=await getAll(STORE.photos); const list=all.filter(p=>p.projectId===pid).sort((a,b)=>a.createdAt.localeCompare(b.createdAt));
  wrap.classList.remove('hidden'); gal.innerHTML='';
  list.forEach(p=>{
    const fig=document.createElement('figure');
    const img=document.createElement('img'); img.src=p.dataUrl; img.alt=p.filename||'';
    const cap=document.createElement('figcaption');
    const del=document.createElement('button'); del.className='ghost'; del.textContent='L√∂schen'; del.onclick=async()=>{ if(!confirm('Foto l√∂schen?')) return; await delRec(STORE.photos,p.id); await refreshPhotoGallery(); };
    cap.appendChild(del);
    fig.appendChild(img); fig.appendChild(cap);
    gal.appendChild(fig);
  });
}

// events
window.addEventListener('DOMContentLoaded', async ()=>{
  await ensureAdminExists();
  const cu=localStorage.getItem('cu');
  const pend=localStorage.getItem('cu_pending');
  if(pend){ showSection('forcePwView'); }
  else if(cu){
    currentUser=JSON.parse(cu);
    await enterApp();
  }

  document.getElementById('btnLogin').onclick=async()=>{ const u=document.getElementById('loginUser').value.trim(); const p=document.getElementById('loginPass').value; try{ await login(u,p); }catch(e){ alert('Login fehlgeschlagen'); } };
  document.getElementById('btnLogout').onclick=()=>{ localStorage.removeItem('cu'); localStorage.removeItem('cu_pending'); location.reload(); };
  document.getElementById('btnAddEntry').onclick=addEntryManual;
  document.getElementById('btnAddBatch').onclick=addBatch;
  document.getElementById('monthPicker').onchange=refreshMonth;
  document.getElementById('userFilter').onchange=refreshMonth;
  document.getElementById('btnExportCSV').onclick=exportCSV;
  document.getElementById('btnExportPDF').onclick=exportPDF;
  document.getElementById('btnAddProject').onclick=async()=>{ const name=(document.getElementById('newProjectName').value||'').trim(); const cost=(document.getElementById('newProjectCost').value||'').trim(); if(!name) return alert('Bitte Projektname angeben'); await put(STORE.projects,{id:uuid(),name:name,costCenter:(cost||null),archived:false}); document.getElementById('newProjectName').value=''; document.getElementById('newProjectCost').value=''; await loadProjects(); await refreshMonth(); };
  document.getElementById('btnAddPhotos').onclick=addPhotosToProject;
  document.getElementById('projectSelect').onchange=refreshPhotoGallery;
});

// exports
function csvExport(rows){ return rows.map(r=>r.map(x=> '"'+String(x).replaceAll('"','""')+'"').join(',')).join('\n'); }
async function exportCSV(){
  const monthVal=document.getElementById('monthPicker').value||currentMonth();
  const userVal=document.getElementById('userFilter').value||(currentUser&&currentUser.username);
  const rows=[[ 'Datum','Mitarbeiter','Von','Bis','Projekt','Kostenstelle','Pausen (min)','Arbeitszeit','√úberstunden','Notiz' ]];
  const entries=(await getAll(STORE.entries)).filter(e=>e.user===userVal&&(e.date||'').startsWith(monthVal));
  const projs=await getAll(STORE.projects); const pm={}; projs.forEach(p=>pm[p.id]=p);
  let sumW=0,sumO=0; entries.sort((a,b)=>(a.date||'').localeCompare(b.date||'')||(a.start||'').localeCompare(b.start||''));
  for(const e of entries){ const w=Math.max(0,durationMin(e.start,e.end)-(e.breaksMin||0)), o=Math.max(0,w-540); sumW+=w; sumO+=o; const p=pm[e.projectId]||{};
    rows.push([e.date,userVal,fmt(e.start),fmt(e.end),p.name||'',p.costCenter||'',(e.breaksMin||0),minToHHMM(w),minToHHMM(o),e.note||'']); }
  rows.push([]); rows.push(['','','','','SUMME','','',minToHHMM(sumW),minToHHMM(sumO),'']);
  const blob=new Blob([csvExport(rows)],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='monat_'+monthVal+'_'+userVal+'.csv'; a.click(); URL.revokeObjectURL(a.href);
}

async function exportPDF(){
  const monthVal=document.getElementById('monthPicker').value||currentMonth();
  const userVal=document.getElementById('userFilter').value||(currentUser&&currentUser.username);
  const entries=(await getAll(STORE.entries)).filter(e=>e.user===userVal&&(e.date||'').startsWith(monthVal));
  const projs=await getAll(STORE.projects); const pm={}; projs.forEach(p=>pm[p.id]=p);
  entries.sort((a,b)=>(a.date||'').localeCompare(b.date||'')||(a.start||'').localeCompare(b.start||''));
  let sumW=0,sumO=0, rows='';
  const fmtT=(dt)=>{const d=new Date(dt); return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})};
  for(const e of entries){ const w=Math.max(0,durationMin(e.start,e.end)-(e.breaksMin||0)), o=Math.max(0,w-540); sumW+=w; sumO+=o; const p=pm[e.projectId]||{};
    rows+= '<tr><td>'+e.date+'</td><td>'+fmtT(e.start)+'</td><td>'+fmtT(e.end)+'</td><td>'+(p.name||'')+'</td><td class="r">'+(p.costCenter||'')+'</td><td class="r">'+(e.breaksMin||0)+'</td><td class="r">'+minToHHMM(w)+'</td><td class="r">'+minToHHMM(o)+'</td><td>'+(e.note||'')+'</td></tr>'; }
  const html='<!doctype html><html><head><meta charset="utf-8"><title>Monats√ºbersicht '+monthVal+' ‚Äì '+userVal+'</title><style>body{font-family:Arial,sans-serif;margin:24px} table{width:100%;border-collapse:collapse;font-size:12px} th,td{border:1px solid #ddd;padding:6px} th{background:#f3f4f6} .r{text-align:right} tfoot td{font-weight:bold} @media print{@page{size:A4 portrait;margin:12mm}}</style></head><body><h1 style="font-size:18px;margin:0 0 8px">Monats√ºbersicht '+monthVal+' ‚Äì '+userVal+'</h1><table><thead><tr><th>Datum</th><th>Von</th><th>Bis</th><th>Projekt</th><th>Kostenstelle</th><th>Pausen (min)</th><th>Arbeitszeit</th><th>√úberstunden</th><th>Notiz</th></tr></thead><tbody>'+rows+'</tbody><tfoot><tr><td colspan="6" class="r">Summe</td><td class="r">'+minToHHMM(sumW)+'</td><td class="r">'+minToHHMM(sumO)+'</td><td></td></tr></tfoot></table><script>window.print()<\/script></body></html>';
  const w=window.open('','_blank'); w.document.write(html); w.document.close();
}
</script>
</body></html>
